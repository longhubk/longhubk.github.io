<!DOCTYPE html>
<html lang="vi">

<head>
  <title>VSB</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="main.css" />
  <link rel="shortcut icon" href="code.ico">
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/remarkable/1.7.1/remarkable.min.js"></script> -->
  <script src="remarkable.js" type="text/javascript"></script>
  <script src="axios.js" type="text/javascript"></script>
  <script src="index.js" type="text/javascript"></script>
  <script src="countdown.js" type="text/javascript"></script>
</head>

<body>
  <div class="container">
    <ul id="nav">
      <li><a href="/">Home</a></li>
    </ul>
    <div>
      <h1 id="tit"></h1>
      <div id="blg"></div>
      <audio controls loop id="aud">
        <source id="aud-src" src="" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>
      <div class="search-box" id="i-cmt">
        <input id="ic" type="text" value="" placeholder="comment something..." />
        <button id="bc" onclick="btnComment()">comment</button>
      </div>
      <div id="cmt"></div>
    </div>
  </div>
  <footer></footer>
  <script type="text/javascript">
    const blg = document.getElementById('blg');
    const tit = document.getElementById('tit');
    const cmt = document.getElementById('cmt');
    const iCmt = document.getElementById('i-cmt');
    const ipCmt = document.getElementById('ic');
    const btnCmt = document.getElementById('bc');
    const noteTag = document.getElementById('note-tag');
    const role = getQueryParam('role');
    const noteId = getQueryParam('noteId');

    const btnComment = async() => {
      const comment = {
        noteId,
        content: ipCmt.value,
      }
      const res = await createComment(comment);
      if (res.code === '00') {
        window.location.reload();
      } else {
        window.alert(`comment failed: ${res.msg}`);
      }
    };

    (async() => {
      getFooter();
      const isLogin = await checkIsLogin();
      if (!isLogin) {
        btnCmt.disabled = true;
      }
      const listCMTs = await getComments(noteId);
      let htmlCMTs = ''
      if (listCMTs) {
        for (const c of listCMTs) {
          htmlCMTs += `<div class="box-ver"><b>${c.createBy.username}</b> : ${c.content}</div>`;
        }
      }
      cmt.innerHTML = htmlCMTs;

      if (role !== undefined) {
        if (Number(role) === 1) {
          note = await getAdminNote(noteId);
        } else if (Number(role) === 2) {
          note = await getNoteShare(noteId);
        }
      } else {
        note = await getNote(noteId);
      }
      if (note) {
        const aud = document.getElementById('aud');
        const aud_src = document.getElementById('aud-src');
        aud_src.src = 'https://dblogit.herokuapp.com/' + note._id + '.mp3';
        aud.autoplay="true";
        aud.load(); //call this to just preload the audio without playing
        setTimeout(() => {
          aud.play();
        }, 5000);

        tit.innerHTML = note.title;
        if (note.countdown !== undefined && note.countdown !== null && Number(role) === 2) {
          // "Feb 14, 2022 0:0:0"
          const countDownDate = new Date(note.countdown).getTime();
          const now = new Date().getTime();
          const delta = countDownDate - now;
          if (delta > 0) {
            setCountdown(countDownDate, blg);
          } else {
            blg.innerHTML = renderNote(note.content);
          }
        } else {
          blg.innerHTML = renderNote(note.content);
        }
      } else {
        blg.innerHTML = 'Not found'
      }
    })();
  </script>
</body>

</html>