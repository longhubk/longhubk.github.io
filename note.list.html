<!DOCTYPE html>
<html lang="vi">
  <head>
    <title>VSB</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="styles/main.css" />
    <link rel="shortcut icon" href="code.ico" />
    <!-- <script src="scripts/https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
  <script src="scripts/https://cdn.jsdelivr.net/remarkable/1.7.1/remarkable.min.js"></script> -->
    <script src="scripts/remarkable.js" type="text/javascript"></script>
    <script src="scripts/axios.js" type="text/javascript"></script>
    <script src="scripts/index.js" type="text/javascript"></script>
    <script src="scripts/countdown.js" type="text/javascript"></script>
  </head>

  <body>
    <div class="container">
      <ul id="nav">
        <li><a href="/">Home</a></li>
      </ul>
      <div>
        <div class="fx space-b" id="tit-box">
          <h1 id="tit"></h1>
        </div>
        <div id="aud-box"></div>
        <div id="blg">Loading...</div>
        <div class="search-box" id="i-cmt"></div>
        <div id="cmt"></div>
      </div>
    </div>
    <footer></footer>
    <script type="text/javascript">
      const blg = document.getElementById("blg");
      const tit = document.getElementById("tit");
      const cmt = document.getElementById("cmt");
      const iCmt = document.getElementById("i-cmt");
      const ipCmt = document.getElementById("ic");
      const btnCmt = document.getElementById("bc");
      const noteTag = document.getElementById("note-tag");
      const role = getQueryParam("role");
      const noteId = getQueryParam("noteId");

      const btnComment = async () => {
        const comment = {
          noteId,
          content: ipCmt.value,
        };
        const res = await createComment(comment);
        if (res.code === "00") {
          window.location.reload();
        } else {
          window.alert(`comment failed: ${res.msg}`);
        }
      };

      (async () => {
        const isLogin = await checkIsLogin();
        const listCMTs = await getComments(noteId);
        let htmlCMTs = "";
        if (listCMTs) {
          for (const c of listCMTs) {
            htmlCMTs += `<div class="box-ver"><b>${c.createBy.username}</b> : ${c.content}</div>`;
          }
        }
        cmt.innerHTML = htmlCMTs;

        if (role !== undefined) {
          if (Number(role) === 1) {
            note = await getAdminNote(noteId);
          } else if (Number(role) === 2) {
            note = await getNoteShare(noteId);
          }
        } else {
          note = await getNote(noteId);
        }
        if (note) {
          try {
            const aud_uri = server_url + "/" + note._id + ".mp3";
            const isExist = await axios.get(aud_uri);
            if (isExist) {
              const aud_box = document.getElementById("aud-box");
              aud_box.innerHTML = `
              <audio controls autoplay loop id="aud">
                <source id="aud-src" src="scripts/" type="audio/mpeg" />
                Your browser does not support the audio element.
              </audio>`;
              const aud = document.getElementById("aud");
              const aud_src = document.getElementById("aud-src");
              aud_src.src = aud_uri;
              aud.autoplay = "true";
              aud.muted = true;
              aud.load(); //call this to just preload the audio without playing
              setTimeout(() => {
                console.log("start audio");
                aud.play();
                aud.muted = false;
              }, 5000);
            }
          } catch (err) {
            console.log("Not exist audio", err);
          }

          tit.innerHTML = note.title;
          if (
            note.countdown !== undefined &&
            note.countdown !== null &&
            Number(role) === 2
          ) {
            // "Feb 14, 2022 0:0:0"
            const countDownDate = new Date(note.countdown).getTime();
            const now = new Date().getTime();
            const delta = countDownDate - now;
            if (delta > 0) {
              setCountdown(countDownDate, blg);
            } else {
              blg.innerHTML = renderNote(note.content);
            }
          } else {
            blg.innerHTML = renderNote(note.content);
          }
          if (isLogin) {
            const cmtBox = document.getElementById("i-cmt");
            cmtBox.innerHTML = `<input
              id="ic"
              type="text"
              value=""
              placeholder="comment something..."
            />
            <button id="bc" onclick="btnComment()">comment</button>`;

            const titBox = document.getElementById("tit-box");
            titBox.innerHTML =
              titBox.innerHTML +
              `<button onClick="redirect('/note.edit.html?noteId=${note._id}')">edit</button>`;
          }
        } else {
          blg.innerHTML = NOT_FOUND;
        }
        getFooter();
      })();
    </script>
  </body>
</html>
