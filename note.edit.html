<!DOCTYPE html>
<html>

<head>
  <title>VSB</title>
  <link rel="stylesheet" type="text/css" href="main.css" />
  <link rel="shortcut icon" href="code.ico">
  <script src="axios.js" type="text/javascript"></script>
  <script src="index.js" type="text/javascript"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <div class="container">
    <ul id="nav">
      <li><a href="/">Home</a></li>
    </ul>
    <div>
      <textarea id="txt-title" rows="2"></textarea><br /><br />
      <textarea id="txt-content" rows="30"></textarea><br /><br />
      <select id="note-state">
        <option value="0">Publish</option>
        <option value="1">Private</option>
        <option value="2">Hidden</option>
      </select>
      <select id="note-tag">
      </select>
      <button onclick="update()">update</button>
      <div style="width: 2rem"></div>
    </div>
  </div>
  <footer>
  </footer>
  <script type="text/javascript">
    const txtField = document.getElementById('txt-content');
    const txtTitle = document.getElementById('txt-title');
    const noteState = document.getElementById('note-state');
    const noteTag = document.getElementById('note-tag');
    let note;

    (async () => {
      const isLogin = await checkIsLogin();
      if (!isLogin) {
        window.location.href = '/';
      }
    })();

    (async () => {
      getFooter();
      const noteId = getQueryParam('noteId');
      note = await getAdminNote(noteId);
      txtTitle.value = note.title;
      txtField.value = note.content;
      noteState.value = note.state;

      const listTag = await getTag();
      let innerTag = ``;
      for(const tag of listTag) {
        innerTag += `<option value="${tag._id}">${tag.name}</option>`;
      }
      noteTag.innerHTML = innerTag;
      noteTag.value = note.tag;
    })();

    const update = async () => {
      const updateData = { title: txtTitle.value, content: txtField.value, state: noteState.value, tag: noteTag.value }
      const res = await updateNote(updateData, note);
      if (res.code === '00') {
        window.alert('update successfully');
        window.location.href = `/note.list.html?noteId=${note._id}&role=1`;
      } else {
        window.alert(`update failed: ${res.msg}`);
      }
    }

  </script>
</body>

</html>